name: RuStore Auto Deploy (AAB)

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

env:
  # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  PACKAGE_NAME: com.example.yourapp # –ò–ó–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à package name

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          # –ù—É–∂–µ–Ω –¥–ª—è –ø—É—à–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ versionCode) –æ–±—Ä–∞—Ç–Ω–æ –≤ main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚òï –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç (jq –¥–ª—è JSON)
        run: sudo apt-get install jq

      - name: üìù –£–≤–µ–ª–∏—á–µ–Ω–∏–µ versionCode –∏ –∫–æ–º–º–∏—Ç
        id: versioning
        run: |
          # –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ –≤–µ—Ä—Å–∏–∏ –∏–∑ version.txt
          CURRENT_CODE=$(cat version.txt) 
          NEW_CODE=$((CURRENT_CODE + 1))
          echo "–ü—Ä–µ–¥—ã–¥—É—â–∏–π versionCode: $CURRENT_CODE. –ù–æ–≤—ã–π: $NEW_CODE"
          echo $NEW_CODE > version.txt # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
          
          # –ó–∞–ø–∏—Å—å –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
          echo "NEW_CODE=$NEW_CODE" >> $GITHUB_ENV
          
          # –ö–æ–º–º–∏—Ç –∏ –ø—É—à –Ω–æ–≤–æ–≥–æ versionCode –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          git config user.email "ci-bot@users.noreply.github.com"
          git config user.name "CI-Bot"
          git add version.txt
          git commit -m "chore: Auto bump versionCode to $NEW_CODE [skip ci]" || echo "No changes to commit"
          git push || echo "No version commit needed"

      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keystore (–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
        # –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç Keystore –∏–∑ Base64 —Å–µ–∫—Ä–µ—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∫ —Ñ–∞–π–ª app/release.jks
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > app/release.jks

      - name: üîë –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ–¥–ø–∏—Å–∏ (signing.properties)
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏, –∏—Å–ø–æ–ª—å–∑—É—è –°–µ–∫—Ä–µ—Ç—ã GitHub
        run: |
          echo "storeFile=release.jks" >> app/signing.properties
          echo "storePassword=${{ secrets.SIGNING_KEYSTORE_PASSWORD }}" >> app/signing.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> app/signing.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> app/signing.properties

      - name: üì¶ –°–±–æ—Ä–∫–∞ AAB –≤ —Ä–µ–ª–∏–∑–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: ./gradlew :app:bundleRelease

      - name: üîç –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ AAB
        id: find_aab
        # AAB —Ñ–∞–π–ª –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è app-release.aab
        run: |
          AAB_PATH=$(find app/build/outputs/bundle/release/ -name "app-release.aab" -print -quit)
          echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT

      - name: üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è RuStore API –¢–æ–∫–µ–Ω–∞
        id: get_token
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST 'https://public-api.rustore.ru/public/v1/authorize' \
            -H 'Content-Type: application/json' \
            -d '{
              "keyId": "${{ secrets.RUSTORE_KEY_ID }}",
              "privateKey": "${{ secrets.RUSTORE_PRIVATE_KEY }}"
            }')
          TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.body.jwe')
          # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω, —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then 
            echo "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RUSTORE_KEY_ID –∏ RUSTORE_PRIVATE_KEY."
            echo "–û—Ç–≤–µ—Ç API: $TOKEN_RESPONSE"
            exit 1
          fi
          echo "rustore_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤–µ—Ä—Å–∏–∏
        id: create_version
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π versionCode –≤ –∫–∞—á–µ—Å—Ç–≤–µ versionId
          VERSION_ID=${{ env.NEW_CODE }}
          
          VERSION_RESPONSE=$(curl -s -X POST "https://public-api.rustore.ru/public/v1/application/${{ env.PACKAGE_NAME }}/version" \
            -H 'Content-Type: application/json' \
            -H "Public-Token: ${{ steps.get_token.outputs.rustore_token }}" \
            -d "{
              \"versionId\": $VERSION_ID,
              \"publishType\": \"INSTANTLY\", 
              \"partialValue\": 100 
            }")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º ID (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å NEW_CODE)
          CODE=$(echo $VERSION_RESPONSE | jq -r '.code')
          if [ "$CODE" != "OK" ]; then 
            echo "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞. –í–æ–∑–º–æ–∂–Ω–æ, versionId $VERSION_ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
            echo "–û—Ç–≤–µ—Ç API: $VERSION_RESPONSE"
            exit 1
          fi
          
          echo "–°–æ–∑–¥–∞–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ —Å ID: $VERSION_ID"
          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ AAB —Ñ–∞–π–ª–∞ –≤ RuStore
        run: |
          AAB_PATH="${{ steps.find_aab.outputs.aab_path }}"
          VERSION_ID="${{ steps.create_version.outputs.version_id }}"
          
          curl -s -X POST "https://public-api.rustore.ru/public/v1/application/${{ env.PACKAGE_NAME }}/version/$VERSION_ID/aab" \
            -H "Public-Token: ${{ steps.get_token.outputs.rustore_token }}" \
            -F "file=@$AAB_PATH"

      - name: ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—Ä—Å–∏–∏ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
        run: |
          VERSION_ID="${{ steps.create_version.outputs.version_id }}"
          
          MODERATION_RESPONSE=$(curl -s -X POST "https://public-api.rustore.ru/public/v1/application/${{ env.PACKAGE_NAME }}/version/$VERSION_ID/moderation" \
            -H 'Content-Type: application/json' \
            -H "Public-Token: ${{ steps.get_token.outputs.rustore_token }}")
          
          CODE=$(echo $MODERATION_RESPONSE | jq -r '.code')
          if [ "$CODE" != "OK" ]; then 
            echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –≤—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ RuStore."
            echo "–û—Ç–≤–µ—Ç API: $MODERATION_RESPONSE"
            exit 1
          fi
          
          echo "–í–µ—Ä—Å–∏—è $VERSION_ID —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é RuStore."